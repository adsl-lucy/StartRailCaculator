# StartRailCaculator
蒙特卡洛方法求解：卡池出货分布/抽卡结果分布/有效圣遗物出货概率

参考图片（照骗）
![10 179抽出货分布](https://github.com/adsl-lucy/StartRailCaculator/assets/42862216/45f325f4-fbb4-4984-b9c1-8cdf64135e5c)

开发工具：VS2710
Qt版本：5.12.11\msvc2017_64

下载地址：

编译所需包含模块
1.	charts
2.	core
3.	datavisualization
4.	gui
5.	widgets

1.工程简介
2.操作方法，具体的计算方案和数值说明
3.值得注意的统计结论

1.	工程简介
编写本软件主要是为了解决米氏手游常见决策问题：抽卡决策/圣遗物决策。因为在这两个内容的投入边际收益的递减过于陡峭，所以为了避免资源的大量浪费，需要利用适当的计算来辅助决策。而使用excel直接计算的方案在面对复杂策略时不仅公式冗长而且难以校错，于是最终采用了软件模拟的方案来获得答案（玩游戏像上班）。这催生出了这个工程的四个界面
1.	资源估算界面 
2.	N抽之内出货概率界面 
3.	资源投入与分析界面 
4.	有效圣遗物估计界面
其中第一个界面用于估算某个卡池日期范围内，抽卡资源的存量分布。第二个界面用于用于估算一个具体的卡池状态下，出货的平均消耗，为一个角色/武器大致消耗的资源提供参考。第三个界面用于分析投入指定资源下，获得特定收益的概率分布。常用于决定是否要抽多个角色/武器。第四个界面用于估算获得特定圣遗物所需要的打本次数。
	除了第一个界面使用直接计算的方法，其余三个界面均采用蒙特卡洛的模拟方案。因为后三个界面对应的计算事件次数都是有限的，依照大数定律，重复足够多次实验后，事件重复频率趋于事件概率。在多次试验下，发现模拟次数为十万次时，计算速率和精度均足以满足实用需求。所以后三个界面的模拟次数均是十万次。
从数据的参考价值来看，角色的出货概率官方有公布的数值，所以模拟结果和实际情况应当非常接近，但是需要注意官方并没有公布圣遗物词条和套装的概率分布，而软件圣遗物概率计算是基于一张网图，所以原则上第四个界面的计算结论仅供娱乐（体感好像也差不多）。







2.操作方法，具体的计算方案和数值说明

1.资源估算界面 
![3 资源估算界面](https://github.com/adsl-lucy/StartRailCaculator/assets/42862216/fd1d7769-3c1f-452b-9088-52604292d42a)

右侧输入计算的开始日期，以及开始日期的资源状态，点开始计算，即会画出计算结果，左侧为每一天的资源变化，上侧图像是所有资源换算成星琼的结果（把古老梦华也算入），下侧图像是所有资源都还算成专卡的结果，右侧计算结果栏包含了指定停止日期下的资源状态，以及预计还会投入的RMB。
停止日期最晚不能晚于2024/4/26的原因在于实际情况下还会有活动收益，这会带来很大的误差（总收益可能和日常+模拟宇宙相当），但是目前活动收益的平均值难以估算（每个版本送十连过于科幻），所以索性忽略。
计算过程就是直接计算，其具体步骤是
1.	默认已经获得了第一天的收益，不计算当天收益，直接从第二天开始算
2.	（如果勾了小月卡）登录获得小月卡收益（90星琼），小月卡到期就花30RMB，然后获得当天收益（300星琼+300古老梦华）
3.	做日常获得60星琼
4.	如果是每周第一天，那么打模拟宇宙获得225星琼（最高突破等级）
5.	如果是每个月第一天，那么去商店换取5张专票
6.	如果是开服后日期两周的倍数（两周刷一次），那么打深渊，依照平均通关次数获得收益
7.	如果是大版本更新（6周一次）那么默认获得300更新收益和300修BUG收益
8.	如果是开服后日期42天的倍数（同大版本更新），且购买大月卡，那么花68买大月卡
9.	如果购买了大月卡，那么默认每周经验打满，购买大月卡后的第一周获得1抽，第二周获得1抽，第三周获得2抽，第五周获得680星琼
左侧图表鼠标悬停可以获得某个日期的具体资源状况，但是QChart自带一些BUG，可能悬停位置和绘图内容有偏差，所以得多移几下


2.卡池收益界面
 ![4 卡池收益界面](https://github.com/adsl-lucy/StartRailCaculator/assets/42862216/860b339c-c0b1-4a3c-a599-ab4797b0e950)

右侧输入卡池状态，左侧查看出货位置的概率分布。其中已垫抽数为历史最后一次出UP金之后，在往后投入的抽数。而上一个五星歪了，表示历史最后一次出金，不是up金。比如上一个池子出货后，又扔了80抽，但是第40抽歪了，所以已垫抽数是80抽，歪了要打勾。
模拟的过程为：
1.	如果距离历史最后一次出金角色池没有满90抽，武器池没有满80抽，那么角色0.6%出金，光锥0.5%出金。
2.	如果距离历史最后一次出金角色池已经满了90抽，武器池满了80抽，那么直接出金
3.	如果出金且历史最后一次出金是那个时候卡池的up金，那么角色50%可能出up金，光锥75%出up金。如果历史最后一金歪了，那么角色池和武器池必出当期卡池up金
4.	重复上述过程10万次，每次记录出金的位置，统计出货位置的概率密度，最后最累加得到上图
左侧图像上某一点的纵坐标表示投入的抽数，横坐标表示概率，曲线上某一点表示在当前抽数之内出货的概率，比如图示悬停状态，表示当前卡池状态下投入96抽的出up金概率为57.5%。这其中也包含了多次出货的可能（但是可能性非常小）。可以为出货的位置给出一个估计。右侧统计结论内得期望出货位置为出货的平均位置，对应的投入为期望投入星琼







3.出货分析界面
![5 出货分析界面](https://github.com/adsl-lucy/StartRailCaculator/assets/42862216/577fd218-cfeb-43fa-bfb7-ca6be932a56b)
 
右侧输入当前卡池状态，抽卡方式，以及想要投入的资源合计。点开始分析就会重复模拟将资源耗尽的出货状态。由于出货概率是一个概率矩阵，所以采用3D的方式现实数值。左侧图表的x和y轴分别对应角色和武器的出货状态，柱子为xy坐标对应出货状态的概率密度。鼠标右键点击3D图表，拖拽即可改变摄像机角度，滚轮改变摄像机缩放。左键点击柱子会现实对应事件的概率值
右侧统计数值会现实将投入资源耗尽后预期的沉船概率和收益期望。对于1000抽以内的情形，模拟收敛程度较好。（一次1000抽以上的石油佬需要这个功能？）。卡池轮换方式主要用于适应抽高命座的情形。
	因为参考的是官方公布的概率分布，所以这个界面是这个实用度最高的界面。

















4.有效圣遗物估算界面
![6 有效圣遗物估算界面](https://github.com/adsl-lucy/StartRailCaculator/assets/42862216/480600ba-1801-41de-814e-e8874edf37d4)
 
	这个界面比较复杂，主要是为刷指定圣遗物提供体力开销的估计值。一次估计只能计算某一个本内一个套装的一个指定部位的出货概率。
主属性除了头和手都可以多选。多选主属性过程不能选不存在的主属性（比如衣服不能选充能）。虽然之前绳子勾了充能，但是轮到衣服的时候，那个充能灰掉的勾是不参与计算的。有效副词缀可以多选同时设置满足条件的最低数值。如果有效副词缀没有勾某一个属性比如：防御值，那么模拟过程一旦出的圣遗物副属性包含了防御值，那么这个圣遗物就被视为副词缀无效（但是这不妨碍主属性正确）。
如果主属性和副属性内同时勾了速度，那么不论是主属性为速度，还是主属性为其他，副词条有速度，这个圣遗物都会进入下一轮的数值比较环节。注意不要设置超出副词缀数值上限的副词缀条件，因为上述情形下主属性为速度的时而速度要求大于25时，这个圣遗物直接通过，但是实际情况不存在这种圣遗物。
打本次数指一次模拟下打本的次数。如果打本次数为100，那么会重复10万次实验，每次实验打100次本。对于模拟宇宙，一次打本就是打完BOSS后摸一次奖励。
副词缀要求里，如果是百分比，那么输入百分比格式的数值，比如百分比攻击希望大于6.9%，那么输入6.9。而对于绝对值，比如速度，希望大于2.5，就输入2.5.
实际模拟过程的参考概率源自一张网图
![7](https://github.com/adsl-lucy/StartRailCaculator/assets/42862216/a1446cd9-17ef-4d99-8359-907a92648593)
 
	毕竟不是官方公布的数值，所以模拟结论只能看看
	实际的模拟过程为
1.	先随机打本获得的圣遗物个数，90%概率出2个金，10%概率3个金
2.	每一个圣遗物50%套装错误，套装错误就丢弃，套装正确进入下一节
3.	套装正确的圣遗物，普通副本75%可能部位错误，模拟宇宙50%可能部位错误。如果部位错误就丢弃，部位正确进入下一节
4.	套装正确的圣遗物，依照主属性概率密度随机获得一个主属性，如果主属性不对，那么丢弃，如果主属性正确，那么主属性正确的计数+1同时进入下一节
5.	依照初始副词缀数量的概率密度随机获得若干副词缀和初始数值，然后模拟圣遗物升级一路升满，填满副词缀和数值，期间任意一个环节出现无效副词缀那么丢弃，如果副词缀全部有效，那么比较数值，满足输入副词缀数值的所有条件，那么全属性正确的计数+1
实验过程会统计4个主要数值
1.	主属性正确的圣遗物占获得圣遗物的比例
2.	打一次本获得主属性正确圣遗物的概率
3.	全属性正确的圣遗物占获得圣遗物的比例
4.	打一次本获得全属性正确圣遗物的概率
这分别对应了右侧统计结论的前两行。统计结论第三行和第四行为推算数值。第三行表示打指定次数本后，获得满足指定条件（主属性正确/全属性正确）圣遗物的期望个数（统计平均个数）。第四行为获得满足指定条件圣遗物所需打本的期望次数（统计平均次数）
左侧上半图表，表示打指定次数本后，获得主属性有效部件个数的概率分布，下半图表表示打指定次数本后，获得全部属性有效部件个数的概率分布。实际模拟过程获得最低概率部件（极品爆伤/暴击衣）的出现比例大致在100万分之31上下，打一次本获得的遗物数量期望为2.1个，如果希望这个部件在整个模拟过程出现至少1000次，其期望的累计打本次数为
 ![image](https://github.com/adsl-lucy/StartRailCaculator/assets/42862216/73afa954-a63a-47e0-b86f-c917287ea3ff)

实际模拟实验次数为100000次，如果每次实验打200次本，那么整个模拟一共打本2千万次，次数就足够出1000个满足条件的遗物，其获得概率值已经比较准确，所以对于更高概率的部件，每次打本实验次数为200时得到的统计值收敛度只会更高。于是默认实验的打本次数为200次。但是如果想要获得更光滑的图表，那么只能提升打本次数，此时模拟的耗时会快速增长。
	对于一般而言期望获得的极品圣遗物，可以只勾希望的副词条： 
![8 极品手](https://github.com/adsl-lucy/StartRailCaculator/assets/42862216/6a888d0e-d474-48bb-9fa9-20380eacc7ee)
	而如果希望计算只有3个有效词条的情形，可以全勾副词缀，同时给希望的三个副词缀设施数值为1（大于0同时小于任意一个词缀的最小数值）：
 ![9 三个有效词缀](https://github.com/adsl-lucy/StartRailCaculator/assets/42862216/d62f1404-0bdd-459a-9f20-535ed3b44094)


注意这里的概率分布并非官方概率分布，所以结论仅供娱乐

其他：值得注意的统计结论

1.	角色和武器获取成本
实际模拟发现获取一个UP角色的抽数期望为104.7，对应星琼为16752。而获得一个UP武器的抽数期望为74.16，对应星琼为11864.39。这两个对应了角色和武器的平均成本
把两个期望的抽数累到一起是178.86抽（28617.6星琼）而179抽在出货模拟过程的分布为
![Uploading 10.179抽出货分布.png…]()

	如果按照期望规划卡池，先角色再武器，那么将有17%的概率角色沉船，44.55%的武器沉船。虽然模拟过程忽略的重复角色获得余烬的返利作用，但是专武沉船的概率依旧不小。如果改变策略，变成先抽30发角色，再抽20发武器，结果居然是33%的概率角色沉船，69%的概率武器沉船： 
这种损失增大的效应在于资源有限的情形，再分散投资则同时增大了两个卡池的失败可能。所以对于资源有限的学生党，建议是：“按照期望规划，攒到保底入池，集中资源到少数关键角色/武器”。依照多次模拟的结论，按“先角色再武器”的抽卡次序，大致在220抽-230抽的情况下，UP武器沉船的概率是25%。210抽的情况UP武器沉船的概率是30，所以攒星琼大致攒33600-36800入池子是一个相对保守的方案。
2.免费和氪金资源的收益
上述星琼意味着多大的投入成本？首先看氪金资源的转化率
 ![image](https://github.com/adsl-lucy/StartRailCaculator/assets/42862216/f31979cf-1216-4bdc-8e7d-7a19e4f33ff8)
小月卡投入30元，合计获得3000星琼，转化率为100（平均1元转化为100星琼），大月卡投入68元，累计获得1320等效星琼，转化率20，氪金投入648元，获得6480星琼（忽略双倍等其他活动）转化率为10。可见小月卡是所有资源内效益最高的氪金项目，高于氪金10倍，但是其要求每天上线，而且每个月的收益存在上限。
将日常，小月卡，深渊的收益做一个大致的估算（其中第二行日常包含了每周的模拟宇宙）：
![image](https://github.com/adsl-lucy/StartRailCaculator/assets/42862216/217396fc-c9c9-40c4-81ed-937668aeb77f)
 
依照一个角色+专武的平均成本179抽：
1.	日常+模拟宇宙：平均11个月攒一个角色+专武。
2.	小月卡：平均10个月赞一个角色+专武
3.	打满深渊：平均2年攒一个角色+专武
4.	日常+模拟宇宙+打满深渊：平均8个月攒一个角色+专武
5.	日常+模拟宇宙+小月卡：平均5个月攒一个角色+专武
6.	日常+模拟宇宙+小月卡+打满深渊：平均4个月攒一个角色+专武
如果粗略的将活动收益估算为每6周月2600星琼 + 10连，那么相当于平均每个月2800星琼，于是活动平均10个月送一个角色+专武。而初始新号获得的地图/任务收益差不多36000星琼，相当于225抽，相当于1.25个（角色+专武）
可见小月卡/日常+模拟宇宙/活动+十连这三者的收益非常接近，所以氪不氪小月卡取决是否希望每10个月多抽1个角色+专武。而深渊的收益完全不能和上述三者相提并论，考虑到强度不可避免的更迭/膨胀，以及赛道的多样化，使用普通角色打满5层深渊，随缘后5层是一个比较划算的决策。

3.有效圣遗物统计
使用这个软件模拟圣遗物主属性的概率，和直接计算的概率十分接近
 ![image](https://github.com/adsl-lucy/StartRailCaculator/assets/42862216/0c5922cb-454b-47da-9cd8-6c995402f4e9)

其中获得成本最长的就是双爆衣和速度鞋，按照一天6次，一周7天来看，差不多普通副本主属性集齐需要一周，模拟宇宙部位一周集齐。考虑到实际情况下刷本的副产物还能给别的角色，实际一个角色主属性毕业差不多就1周时间。
再看副属性，实际情况下需求最高的副属性就是
暴击率/爆伤>速度>百分比攻击>固定攻击>其他
如果最低要求是暴击率+爆伤
其次是暴击率+爆伤+速度
极品是暴击率+爆伤+速度 + 百分比攻击/固定攻击
那么不同部位满足上述条件的获取概率和期望的打本次数为
![image](https://github.com/adsl-lucy/StartRailCaculator/assets/42862216/93d89eda-7810-402a-a385-7af0941a3d5d)
 
对于一般玩家，打1-2周圣遗物本属于家常便饭，打1-2个月本属于比较难受，打4-8个月属于弃坑临界点，1-2年属于手游运营的常见拐点，而打4-8年同一个本属于天方夜谭。所以推荐的遗物保留策略是
1.	头/手/攻击绳：先带2个有效副词缀（双爆>速度>攻击）
2.	速度鞋/攻击鞋/双爆衣/球：先带1个有效副词缀
3.	头/手：以3个有效副词缀作为毕业目标
4.	双爆衣/攻击绳：以2个有效副词缀/3个有效副词缀作为毕业目标
5.	攻击衣/攻击鞋/速度鞋/球：以2个有效副词缀作为毕业目标
虽然统计规律对于个例常常失效，但是上述的概率将在多个角色身上快速收敛。为了更好的游戏体验，适当降低期望有助于减少不必要的烦恼。虽然概率计算来自一张网图，但是头/手停留在3个有效副词缀，以及鞋/衣/球/绳停留在2个有效副词缀的情况体感非常常见（非酋の分界线），所以忽略概率的误差，这个遗物保留策略感觉是OK的。
